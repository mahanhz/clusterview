#!groovy

ARTIFACT_NEXUS_URL = ""
ARTIFACT_GROUP = ""
ARTIFACT_NAME = ""
ARTIFACT_VERSION = ""

stage ('Approve deploy?') {
    timeout(time: 5, unit: 'MINUTES') {
        input message: 'Deploy snapshot?'
    }
}

// one at a time!
lock('lock-deploy-snapshot') {
    stage('Deploy snapshot') {
        node {
            timeout(time: 5, unit: 'MINUTES') {

                def props = readProperties file: 'gradle.properties'

                ARTIFACT_NEXUS_URL = props['artifactNexusUrl'];
                ARTIFACT_GROUP = props['artifactGroup'];
                ARTIFACT_NAME = props['artifactName'];
                ARTIFACT_VERSION = props['description'];

                echo 'mahan 1: ' + ARTIFACT_NEXUS_URL

                build job: 'test_download_artifact', parameters: [string(name: 'NEXUS_URL', value: ARTIFACT_NEXUS_URL),
                                                                  string(name: 'REPO', value: 'snapshots'),
                                                                  string(name: 'GROUP', value: ARTIFACT_GROUP),
                                                                  string(name: 'ARTIFACT', value: ARTIFACT_NAME),
                                                                  string(name: 'VERSION', value: ARTIFACT_VERSION)]
            }
        }
    }
}